from flask import Flask, render_template, request, jsonify
import requests
from bs4 import BeautifulSoup
import re
import json
from datetime import datetime
import os
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

app = Flask(__name__)

# Hugging Face API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
HUGGINGFACE_API_URL = "https://api-inference.huggingface.co/models/bigscience/bloomz-560m"
HUGGINGFACE_API_KEY = os.getenv('HUGGINGFACE_API_KEY', '')

# Sherlock Holmes persona
SHERLOCK_PROMPT = """–¢—ã - –®–µ—Ä–ª–æ–∫ –•–æ–ª–º—Å, –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–π –¥–µ—Ç–µ–∫—Ç–∏–≤-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏–∑ –õ–æ–Ω–¥–æ–Ω–∞. 
–¢—ã –∏–∑–≤–µ—Å—Ç–µ–Ω —Å–≤–æ–∏–º –¥–µ–¥—É–∫—Ç–∏–≤–Ω—ã–º –º–µ—Ç–æ–¥–æ–º, –æ—Å—Ç—Ä—ã–º —É–º–æ–º –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é –∑–∞–º–µ—á–∞—Ç—å –º–µ–ª—å—á–∞–π—à–∏–µ –¥–µ—Ç–∞–ª–∏.

–¢–≤–æ–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
- –¢—ã –∂–∏–≤–µ—à—å –Ω–∞ –ë–µ–π–∫–µ—Ä-—Å—Ç—Ä–∏—Ç, 221–ë
- –¢–≤–æ–π –ª—É—á—à–∏–π –¥—Ä—É–≥ –∏ –ø–æ–º–æ—â–Ω–∏–∫ - –¥–æ–∫—Ç–æ—Ä –î–∂–æ–Ω –í–∞—Ç—Å–æ–Ω
- –¢—ã –∏–≥—Ä–∞–µ—à—å –Ω–∞ —Å–∫—Ä–∏–ø–∫–µ –∏ —É–ø–æ—Ç—Ä–µ–±–ª—è–µ—à—å –∫–æ–∫–∞–∏–Ω
- –¢—ã –ø—Ä–µ–∑–∏—Ä–∞–µ—à—å —ç–º–æ—Ü–∏–∏ –∏ –ø–æ–ª–∞–≥–∞–µ—à—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –ª–æ–≥–∏–∫—É
- –¢—ã –≥–æ–≤–æ—Ä–∏—à—å —Å –±—Ä–∏—Ç–∞–Ω—Å–∫–∏–º –∞–∫—Ü–µ–Ω—Ç–æ–º –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —è–∑—ã–∫
- –¢—ã —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Ñ—Ä–∞–∑—ã "–≠–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ, –º–æ–π –¥–æ—Ä–æ–≥–æ–π –í–∞—Ç—Å–æ–Ω" –∏ "–ö–æ–≥–¥–∞ —Ç—ã –∏—Å–∫–ª—é—á–∏—à—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ..."

–û—Ç–≤–µ—á–∞–π –≤ —Å—Ç–∏–ª–µ –®–µ—Ä–ª–æ–∫–∞ –•–æ–ª–º—Å–∞, –∏—Å–ø–æ–ª—å–∑—É—è –¥–µ–¥—É–∫—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è.
–í—Å–µ–≥–¥–∞ –±—É–¥—å –≤–µ–∂–ª–∏–≤, –Ω–æ –Ω–µ–º–Ω–æ–≥–æ –≤—ã—Å–æ–∫–æ–º–µ—Ä–µ–Ω –≤ —Å–≤–æ–µ–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–º –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–µ.

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü: {context}

–í–æ–ø—Ä–æ—Å: {question}

–û—Ç–≤–µ—Ç –®–µ—Ä–ª–æ–∫–∞ –•–æ–ª–º—Å–∞:"""

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫—Ä–∞–ø–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
scraped_content = []

def generate_response(question, context=""):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Hugging Face API –∏–ª–∏ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤"""
    try:
        if not HUGGINGFACE_API_KEY or HUGGINGFACE_API_KEY == "your_huggingface_api_key_here":
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, –µ—Å–ª–∏ API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
            return generate_fallback_response(question, context)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
        prompt = SHERLOCK_PROMPT.format(context=context, question=question)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Hugging Face API
        headers = {
            "Authorization": f"Bearer {HUGGINGFACE_API_KEY}",
            "Content-Type": "application/json"
        }
        
        payload = {
            "inputs": prompt
        }
        
        response = requests.post(HUGGINGFACE_API_URL, headers=headers, json=payload, timeout=30)
        
        if response.status_code == 200:
            result = response.json()
            if isinstance(result, list) and len(result) > 0:
                generated_text = result[0].get('generated_text', '')
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç (–ø–æ—Å–ª–µ –ø—Ä–æ–º–ø—Ç–∞)
                if prompt in generated_text:
                    answer = generated_text[len(prompt):].strip()
                else:
                    answer = generated_text.strip()
                
                # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, –æ–±—Ä–µ–∑–∞–µ–º
                if len(answer) > 500:
                    answer = answer[:500] + "..."
                
                return answer if answer else "–≠–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ, –º–æ–π –¥–æ—Ä–æ–≥–æ–π –í–∞—Ç—Å–æ–Ω! –ù–æ –º–Ω–µ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞."
            else:
                return "–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞."
        else:
            return f"–û—à–∏–±–∫–∞ API: {response.status_code} - {response.text}"
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
        return generate_fallback_response(question, context)

def generate_fallback_response(question, context=""):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –±–µ–∑ API –∫–ª—é—á–∞, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã"""
    question_lower = question.lower()
    
    # –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Å—Ç–∏–ª–µ –®–µ—Ä–ª–æ–∫–∞ –•–æ–ª–º—Å–∞
    if any(word in question_lower for word in ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '–¥–æ–±—Ä—ã–π –¥–µ–Ω—å']):
        return "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥! –Ø –®–µ—Ä–ª–æ–∫ –•–æ–ª–º—Å, –∏ —è –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å –≤–∞–º –≤ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏. <strong>–≠–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ, –í–∞—Ç—Å–æ–Ω!</strong>"
    
    elif any(word in question_lower for word in ['–∫–∞–∫ –¥–µ–ª–∞', '–∫–∞–∫ —Ç—ã']):
        return "–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ, –º–æ–π –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥! –ú–æ–π —É–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã, –∞ –¥–µ–¥—É–∫—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ –ø–∏–∫–µ —Ñ–æ—Ä–º—ã. –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤—ã–º –∑–∞–≥–∞–¥–∫–∞–º!"
    
    elif any(word in question_lower for word in ['–∫—Ç–æ —Ç—ã', '—Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ']):
        return "–Ø –®–µ—Ä–ª–æ–∫ –•–æ–ª–º—Å, –¥–µ—Ç–µ–∫—Ç–∏–≤-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å –ë–µ–π–∫–µ—Ä-—Å—Ç—Ä–∏—Ç, 221–ë. –ú–æ–π –¥–µ–¥—É–∫—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–Ω–µ –∑–∞–º–µ—á–∞—Ç—å —Ç–æ, —á—Ç–æ —É–ø—É—Å–∫–∞—é—Ç –¥—Ä—É–≥–∏–µ. <em>–ö–æ–≥–¥–∞ —Ç—ã –∏—Å–∫–ª—é—á–∏—à—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ, —Ç–æ, —á—Ç–æ –æ—Å—Ç–∞–µ—Ç—Å—è, –∏ –µ—Å—Ç—å –ø—Ä–∞–≤–¥–∞, –∫–∞–∫ –±—ã –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —ç—Ç–æ –Ω–∏ –∫–∞–∑–∞–ª–æ—Å—å.</em>"
    
    elif any(word in question_lower for word in ['–ø–æ–º–æ—â—å', '—á—Ç–æ —É–º–µ–µ—à—å', '–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏']):
        return "–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–∫–ª—é—á–∞—é—Ç: <strong>–¥–µ–¥—É–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑</strong>, <strong>–≤–µ–±-—Å–∫—Ä–∞–ø–∏–Ω–≥</strong>, <strong>RAG —Å–∏—Å—Ç–µ–º—É</strong> –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∏, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, <em>–≤–∏–∫—Ç–æ—Ä–∏–∞–Ω—Å–∫–∏–π —Å—Ç–∏–ª—å —Ä–µ—á–∏</em>. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –º–Ω–µ URL –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å!"
    
    elif any(word in question_lower for word in ['–∑–∞–≥–∞–¥–∫–∞', '–∑–∞–¥–∞—á–∞', '–ø—Ä–æ–±–ª–µ–º–∞']):
        return "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –º–Ω–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π –∑–∞–≥–∞–¥–∫–∏. –ü–æ–º–Ω–∏—Ç–µ, <strong>–¥–µ—Ç–∞–ª–∏ –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ</strong>. –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–ª—é—á–æ–º –∫ —Ä–∞–∑–≥–∞–¥–∫–µ."
    
    elif any(word in question_lower for word in ['–ª–æ–≥–∏–∫–∞', '–¥–µ–¥—É–∫—Ü–∏—è', '–º–µ—Ç–æ–¥']):
        return "–ú–æ–π –¥–µ–¥—É–∫—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏–∏ –∏ –ª–æ–≥–∏–∫–µ. <em>–í—ã –≤–∏–¥–∏—Ç–µ, –Ω–æ –Ω–µ –Ω–∞–±–ª—é–¥–∞–µ—Ç–µ</em>. –Ø –∑–∞–º–µ—á–∞—é –º–µ–ª—å—á–∞–π—à–∏–µ –¥–µ—Ç–∞–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥—Ä—É–≥–∏–µ —É–ø—É—Å–∫–∞—é—Ç, –∏ —Å–æ–µ–¥–∏–Ω—è—é –∏—Ö –≤ –ª–æ–≥–∏—á–µ—Å–∫—É—é —Ü–µ–ø–æ—á–∫—É."
    
    elif any(word in question_lower for word in ['–≤–∞—Ç—Å–æ–Ω', '–¥–æ–∫—Ç–æ—Ä']):
        return "–ê—Ö, –º–æ–π –¥–æ—Ä–æ–≥–æ–π –í–∞—Ç—Å–æ–Ω! –ú–æ–π –≤–µ—Ä–Ω—ã–π –¥—Ä—É–≥ –∏ –ø–æ–º–æ—â–Ω–∏–∫. –•–æ—Ç—è –æ–Ω –∏–Ω–æ–≥–¥–∞ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –º–æ–∏—Ö –º–µ—Ç–æ–¥–æ–≤, –µ–≥–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –∏ –∑–∞–ø–∏—Å–∏ –Ω–∞—à–∏—Ö –¥–µ–ª –±–µ—Å—Ü–µ–Ω–Ω—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∫—Ä–∏–º–∏–Ω–∞–ª–∏—Å—Ç–∏–∫–∏."
    
    elif any(word in question_lower for word in ['–ª–æ–Ω–¥–æ–Ω', '–±–µ–π–∫–µ—Ä-—Å—Ç—Ä–∏—Ç']):
        return "–î–∞, —è –∂–∏–≤—É –Ω–∞ –ë–µ–π–∫–µ—Ä-—Å—Ç—Ä–∏—Ç, 221–ë, –≤ –õ–æ–Ω–¥–æ–Ω–µ. –ú–æ–π –¥–æ–º - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∂–∏–ª–∏—â–µ, —ç—Ç–æ —Ü–µ–Ω—Ç—Ä –º–æ–∏—Ö —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π. –ó–¥–µ—Å—å —è –∏–≥—Ä–∞—é –Ω–∞ —Å–∫—Ä–∏–ø–∫–µ, –ø—Ä–æ–≤–æ–∂—É —Ö–∏–º–∏—á–µ—Å–∫–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –∏ –ø—Ä–∏–Ω–∏–º–∞—é –∫–ª–∏–µ–Ω—Ç–æ–≤."
    
    elif any(word in question_lower for word in ['—Å–∫—Ä–∏–ø–∫–∞', '–º—É–∑—ã–∫–∞']):
        return "–ú—É–∑—ã–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç –º–Ω–µ –¥—É–º–∞—Ç—å, –º–æ–π –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥. –ö–æ–≥–¥–∞ —è –∏–≥—Ä–∞—é –Ω–∞ —Å–∫—Ä–∏–ø–∫–µ, –º–æ–π —É–º –º–æ–∂–µ—Ç —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ —Å–∞–º—ã—Ö —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–≥–∞–¥–∫–∞—Ö. –≠—Ç–æ –∫–∞–∫ –º–µ–¥–∏—Ç–∞—Ü–∏—è –¥–ª—è –¥–µ–¥—É–∫—Ç–∏–≤–Ω–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è."
    
    elif context and len(context) > 10:
        # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –≤–µ–±-—Å–∫—Ä–∞–ø–∏–Ω–≥–∞
        return f"–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —è –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ: <strong>–∫–æ–Ω—Ç–µ–∫—Å—Ç –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω</strong>. –¢–µ–ø–µ—Ä—å —è –º–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
    
    else:
        # –û–±—â–∏–π –æ—Ç–≤–µ—Ç
        responses = [
            "–•–º, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, –º–æ–π –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥. –ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –¥–µ–¥—É–∫—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∫ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É.",
            "–≠–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ! –•–æ—Ç—è, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ —Å–æ–≤—Å–µ–º. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º —ç—Ç–æ –ø–æ –ø–æ—Ä—è–¥–∫—É.",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∑–∞–≥–∞–¥–∫–∞! –ú–æ–π —É–º —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥ —Ä–µ—à–µ–Ω–∏–µ–º.",
            "–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É —Å–∏—Ç—É–∞—Ü–∏—é —Å –ø–æ–º–æ—â—å—é –ª–æ–≥–∏–∫–∏ –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è.",
            "–•–º, —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –ú–æ–π –¥–µ–¥—É–∫—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –≤ –¥–µ–π—Å—Ç–≤–∏–∏!",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–ª—é—á–æ–º –∫ —Ä–∞–∑–≥–∞–¥–∫–µ. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –±–æ–ª—å—à–µ.",
            "–ú–æ–π –¥–æ—Ä–æ–≥–æ–π –í–∞—Ç—Å–æ–Ω, —ç—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å–ª—É—á–∞–π –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–µ–¥—É–∫—Ç–∏–≤–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞!",
            "–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –º–µ—Ç–æ–¥: <em>–∫–æ–≥–¥–∞ —Ç—ã –∏—Å–∫–ª—é—á–∏—à—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ, —Ç–æ, —á—Ç–æ –æ—Å—Ç–∞–µ—Ç—Å—è, –∏ –µ—Å—Ç—å –ø—Ä–∞–≤–¥–∞</em>."
        ]
        import random
        return random.choice(responses)

def scrape_website(url):
    """–°–∫—Ä–∞–ø–∏–Ω–≥ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
    try:
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        }
        
        response = requests.get(url, headers=headers, timeout=10)
        response.raise_for_status()
        
        soup = BeautifulSoup(response.content, 'html.parser')
        
        # –£–¥–∞–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç—ã –∏ —Å—Ç–∏–ª–∏
        for script in soup(["script", "style"]):
            script.decompose()
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
        text = soup.get_text()
        
        # –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç
        lines = (line.strip() for line in text.splitlines())
        chunks = (phrase.strip() for line in lines for phrase in line.split("  "))
        text = ' '.join(chunk for chunk in chunks if chunk)
        
        return {
            'url': url,
            'title': soup.title.string if soup.title else url,
            'content': text[:2000],  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
            'timestamp': datetime.now().isoformat()
        }
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞: {e}")
        return None

def find_relevant_context(question, top_k=3):
    """–ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è RAG (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
    if not scraped_content:
        return ""
    
    try:
        # –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        question_lower = question.lower()
        relevant_chunks = []
        
        for content in scraped_content:
            content_lower = content['content'].lower()
            
            # –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å–ª–æ–≤
            question_words = set(question_lower.split())
            content_words = set(content_lower.split())
            
            # –í—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
            common_words = question_words.intersection(content_words)
            relevance_score = len(common_words) / len(question_words) if question_words else 0
            
            if relevance_score > 0.1:  # –ü–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
                relevant_chunks.append((relevance_score, content['content'][:500]))
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        relevant_chunks.sort(reverse=True)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç
        relevant_context = "\n".join([text for _, text in relevant_chunks[:top_k]])
        return relevant_context
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {e}")
        return ""

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/chat', methods=['POST'])
def chat():
    try:
        data = request.get_json()
        message = data.get('message', '').strip()
        
        if not message:
            return jsonify({'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'})
        
        # –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        context = find_relevant_context(message)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
        response = generate_response(message, context)
        
        return jsonify({
            'response': response,
            'timestamp': datetime.now().strftime('%H:%M:%S')
        })
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —á–∞—Ç–∞: {e}")
        return jsonify({'error': '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞'})

@app.route('/scrape', methods=['POST'])
def scrape():
    try:
        data = request.get_json()
        url = data.get('url', '').strip()
        
        if not url:
            return jsonify({'error': 'URL –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'})
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if not url.startswith(('http://', 'https://')):
            url = 'https://' + url
        
        # –°–∫—Ä–∞–ø–∏–Ω–≥
        scraped_data = scrape_website(url)
        
        if not scraped_data:
            return jsonify({'error': '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ URL'})
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
        scraped_content.append(scraped_data)
        
        return jsonify({
            'success': True,
            'title': scraped_data['title'],
            'content': scraped_data['content'][:500] + "..." if len(scraped_data['content']) > 500 else scraped_data['content'],
            'message': f'–£—Å–ø–µ—à–Ω–æ —Å–∫—Ä–∞–ø–ª–µ–Ω —Å–∞–π—Ç: {scraped_data["title"]}'
        })
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞: {e}")
        return jsonify({'error': '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫—Ä–∞–ø–∏–Ω–≥–µ'})

@app.route('/status')
def status():
    return jsonify({
        'api_configured': bool(HUGGINGFACE_API_KEY),
        'scraped_sites': len(scraped_content),
        'model': 'gpt2 (via API)'
    })

if __name__ == '__main__':
    print("ü§ñ –ó–∞–ø—É—Å–∫ AI-–±–æ—Ç–∞ –®–µ—Ä–ª–æ–∫–∞ –•–æ–ª–º—Å–∞ —Å Hugging Face API...")
    
    if not HUGGINGFACE_API_KEY:
        print("‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: HUGGINGFACE_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")
        print("   –î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ API –∫–ª—é—á –≤ —Ñ–∞–π–ª .env")
        print("   –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á –º–æ–∂–Ω–æ –Ω–∞: https://huggingface.co/settings/tokens")
    
    print("üöÄ –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞...")
    app.run(debug=True, host='0.0.0.0', port=5000) 